<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{% block title %}FamilyBook{% endblock %}</title>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <script defer src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    
    <style>
        /* –£–±–∏—Ä–∞–µ–º —Å–∏–Ω—é—é –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        body { -webkit-tap-highlight-color: transparent; }
        /* –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã Alpine –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞ */
        [x-cloak] { display: none !important; }
    </style>
</head>

<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-white transition-colors duration-300"
      x-data="{ 
          darkMode: localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches),
          toggleTheme() {
              this.darkMode = !this.darkMode;
              localStorage.setItem('theme', this.darkMode ? 'dark' : 'light');
              if (this.darkMode) document.documentElement.classList.add('dark');
              else document.documentElement.classList.remove('dark');
          }
      }"
      :class="{ 'dark': darkMode }"
      x-init="$watch('darkMode', val => val ? document.documentElement.classList.add('dark') : document.documentElement.classList.remove('dark')); 
              if(darkMode) document.documentElement.classList.add('dark');">

    {% include 'includes/navbar.html' %}

    <main class="min-h-screen pb-24">
        {% block content %}{% endblock %}
    </main>

    {% block modals %}{% endblock %}

    <audio id="notificationSound" src="/static/sounds/notification.mp3" preload="auto"></audio>

{% set flash = get_flashed_messages(request) %}
{% if flash %}
<div x-data="{ show: true }" 
     x-show="show" 
     x-init="
        setTimeout(() => show = false, 4000);
        // –ó–≤—É–∫ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –ª—é–±–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        document.getElementById('notificationSound').play().catch(e => console.log('–ó–≤—É–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'));
     "
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0 transform translate-y-[-20px]"
     x-transition:enter-end="opacity-100 transform translate-y-0"
     x-transition:leave="transition ease-in duration-300"
     x-transition:leave-start="opacity-100 transform translate-y-0"
     x-transition:leave-end="opacity-0 transform translate-y-[-20px]"
     class="fixed top-20 left-1/2 -translate-x-1/2 z-[100] w-[90%] max-w-md"
     x-cloak>
    
    <div class="flex items-center p-4 rounded-2xl shadow-2xl border backdrop-blur-md
        {% if flash.category == 'success' %} bg-emerald-500/90 border-emerald-400 text-white
        {% elif flash.category == 'error' %} bg-rose-500/90 border-rose-400 text-white
        {% else %} bg-blue-500/90 border-blue-400 text-white {% endif %}">
        
        <div class="mr-3 text-2xl">
            {% if flash.category == 'success' %} ‚úÖ
            {% elif flash.category == 'error' %} ‚ö†Ô∏è
            {% else %} ‚ÑπÔ∏è {% endif %}
        </div>
        
        <div class="flex-1 font-medium">{{ flash.message }}</div>

        <button @click="show = false" class="ml-4 opacity-70 hover:opacity-100 transition-opacity">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>
</div>
{% endif %}

    <script>
        // --- 1. PWA Service Worker ---
        if ('serviceWorker' in navigator) {
            // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º SW —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(err => console.error('PWA Error', err));
            });
        }

        // --- 2. –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–û–î–ê–õ–ö–ê–ú–ò ---
       // --- 2. –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–û–î–ê–õ–ö–ê–ú–ò (–° –ê–ù–ò–ú–ê–¶–ò–ï–ô) ---
function toggleModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) {
        console.error("–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ:", modalId);
        return;
    }

    if (modal.classList.contains('hidden')) {
        // –û–¢–ö–†–´–í–ê–ï–ú
        modal.classList.remove('hidden');
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä —É—Å–ø–µ–ª –ø—Ä–∏–º–µ–Ω–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ hidden
        setTimeout(() => {
            modal.classList.add('opacity-100');
            modal.classList.remove('opacity-0');
            // –ï—Å–ª–∏ –≤–Ω—É—Ç—Ä–∏ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π —Å–¥–≤–∏–≥–∞
            const content = modal.querySelector('#modalContent');
            if (content) content.classList.remove('translate-y-full');
        }, 10);
        document.body.style.overflow = 'hidden'; // –ó–∞–ø—Ä–µ—â–∞–µ–º —Å–∫—Ä–æ–ª–ª —Ñ–æ–Ω–∞
    } else {
        // –ó–ê–ö–†–´–í–ê–ï–ú
        modal.classList.remove('opacity-100');
        modal.classList.add('opacity-0');
        const content = modal.querySelector('#modalContent');
        if (content) content.classList.add('translate-y-full');
        
        // –ñ–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ (300–º—Å) –ø–µ—Ä–µ–¥ —Å–∫—Ä—ã—Ç–∏–µ–º
        setTimeout(() => {
            modal.classList.add('hidden');
            document.body.style.overflow = ''; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª
        }, 300);
    }
}

        // --- 3. –ü–†–ï–í–¨–Æ –§–û–¢–û ---
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –ø–æ—Å—Ç–∞
        function handlePreview(event) {
            const area = document.getElementById('preview-area');
            if (!area) return;
            area.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ
            
            Array.from(event.target.files).forEach(file => {
                const url = URL.createObjectURL(file);
                // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç img
                const img = document.createElement('img');
                img.src = url;
                img.className = "w-24 h-24 object-cover rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm";
                area.appendChild(img);
            });
        }

        // --- 4. –§–£–ù–ö–¶–ò–Ø –°–ê–õ–Æ–¢–ê (–û–¥–∏–Ω–æ—á–Ω—ã–π –≤–∑—Ä—ã–≤) ---
        function triggerConfetti(x, y) {
            if (typeof confetti !== 'function') return;
            
            // –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º—É —Å–µ—Ä–¥—Ü–∞
            const heart = confetti.shapeFromText({ text: '‚ù§Ô∏è', scalar: 2 });
            
            confetti({
                particleCount: 40,        // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å—Ç–∏—Ü
                spread: 80,               // –®–∏—Ä–∏–Ω–∞ —Ä–∞–∑–ª–µ—Ç–∞
                origin: { x: x, y: y },   // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ –∫–Ω–æ–ø–∫–∏
                shapes: [heart],          // –§–æ—Ä–º–∞
                colors: ['#ef4444', '#ec4899', '#f472b6'], // –û—Ç—Ç–µ–Ω–∫–∏ –∫—Ä–∞—Å–Ω–æ–≥–æ –∏ —Ä–æ–∑–æ–≤–æ–≥–æ
                scalar: 1.2,              // –†–∞–∑–º–µ—Ä
                gravity: 0.7,             // –°–∫–æ—Ä–æ—Å—Ç—å –ø–∞–¥–µ–Ω–∏—è
                ticks: 100,               // –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —á–∞—Å—Ç–∏—Ü
                zIndex: 10000,            // –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ
                disableForced3d: true     // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
            });
        }

        // --- 5. –õ–ê–ô–ö–ò (AJAX + –ê–Ω–∏–º–∞—Ü–∏—è) ---
        async function toggleLike(btn, postId) {
            // –ó–∞—â–∏—Ç–∞ –æ—Ç —á–∞—Å—Ç—ã—Ö –∫–ª–∏–∫–æ–≤ (debounce)
            if (btn.dataset.loading === "true") return;
            btn.dataset.loading = "true";

            const iconSpan = btn.querySelector('.heart-icon');
            const countSpan = btn.querySelector('.count');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–æ–∫
            if (!iconSpan || !countSpan) {
                btn.dataset.loading = "false";
                return;
            }

            // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ª–∞–π–∫–Ω—É—Ç–æ –∏–ª–∏ –Ω–µ—Ç)
            const isLiked = iconSpan.textContent.includes('‚ù§Ô∏è') || iconSpan.classList.contains('text-red-500');
            
            // --- –û–ü–¢–ò–ú–ò–°–¢–ò–ß–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê (–°—Ä–∞–∑—É –º–µ–Ω—è–µ–º –≤–∏–¥) ---
            if (isLiked) {
                // –£–±–∏—Ä–∞–µ–º –ª–∞–π–∫
                iconSpan.textContent = 'ü§ç';
                iconSpan.classList.remove('text-red-500');
                
                let cnt = parseInt(countSpan.textContent) || 0;
                countSpan.textContent = Math.max(0, cnt - 1);
            } else {
                // –°—Ç–∞–≤–∏–º –ª–∞–π–∫
                iconSpan.textContent = '‚ù§Ô∏è';
                iconSpan.classList.add('text-red-500');
                
                let cnt = parseInt(countSpan.textContent) || 0;
                countSpan.textContent = cnt + 1;
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∞–ª—é—Ç (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ª–∞–π–∫–µ!)
                const rect = btn.getBoundingClientRect();
                // –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—Ç—Ä –∫–Ω–æ–ø–∫–∏ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –æ—Ç —ç–∫—Ä–∞–Ω–∞ (–¥–ª—è confetti)
                const x = (rect.left + rect.width / 2) / window.innerWidth;
                const y = (rect.top + rect.height / 2) / window.innerHeight;
                triggerConfetti(x, y);
            }

            // --- –û–¢–ü–†–ê–í–ö–ê –ó–ê–ü–†–û–°–ê –ù–ê –°–ï–†–í–ï–† ---
            try {
                const res = await fetch(`/posts/${postId}/like`, { method: 'POST' });
                // –ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äî —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –≤—Ö–æ–¥
                if (res.status === 401) window.location.href = '/login';
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ª–∞–π–∫–∞:", e);
                // –¢—É—Ç –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –æ—Ç–∫–∞—Ç–∞ UI, –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ –ø—Ä–æ—à–µ–ª
            } finally {
                // –°–Ω–∏–º–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –∫–Ω–æ–ø–∫–∏ —á–µ—Ä–µ–∑ 300–º—Å
                setTimeout(() => { btn.dataset.loading = "false"; }, 300);
            }
        }
    </script>
</body>
</html>